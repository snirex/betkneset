<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×—×©×‘×•× ×•×ª ×‘×™×ª ×›× ×¡×ª</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; }
        .sidebar { background: #1e293b; color: white; min-height: 100vh; position: sticky; top: 0; }
        .nav-link { color: #cbd5e1; cursor: pointer; padding: 10px 15px; transition: 0.2s; border-radius: 6px; }
        .nav-link:hover { background: #334155; color: white; }
        .nav-link.active { background: #3b82f6; color: white; }
        .main-content { padding: 30px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .balance-box { font-size: 1.4rem; font-weight: bold; padding: 10px 20px; border-radius: 8px; background: white; border: 1px solid #e2e8f0; }
        .input-bar { background: #f8fafc; border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 sidebar">
            <div class="p-3">
                <h4 class="text-center mb-4 border-bottom pb-3">×§×•×¤×ª ×‘×™×ª ×”×›× ×¡×ª</h4>
                
                <div class="mb-3">
                    <label class="small text-uppercase text-muted">×—×™×¤×•×©/×”×•×¡×¤×ª ××ª×¤×œ×œ</label>
                    <input type="text" id="memberInput" class="form-control form-control-sm" placeholder="×©× ××ª×¤×œ×œ...">
                    <button class="btn btn-primary btn-sm w-100 mt-2" onclick="handleMemberAction()">×—×™×¤×•×© / ×”×•×¡×¤×”</button>
                </div>

                <hr>
                <div id="membersList" class="nav flex-column mb-4">
                    </div>

                <hr>
                <a class="nav-link mb-2" onclick="showPage('summary')"><i class="bi bi-calculator me-2"></i> ×¡×™×›×•× ×—×•×‘×•×ª</a>
                <a class="nav-link" onclick="showPage('settings')"><i class="bi bi-gear me-2"></i> ×”×’×“×¨×•×ª (×¢××•×“ B)</a>
            </div>
        </nav>

        <main class="col-md-9 col-lg-10 main-content">
            
            <div id="page-welcome" class="text-center mt-5">
                <i class="bi bi-bank" style="font-size: 4rem; color: #94a3b8;"></i>
                <h2 class="mt-3">× × ×œ×‘×—×•×¨ ××ª×¤×œ×œ ××¨×©×™××ª ×”×¦×“</h2>
            </div>

            <div id="page-member" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 id="view-member-name">---</h2>
                    <div id="view-balance" class="balance-box">â‚ª 0</div>
                </div>

                <ul class="nav nav-tabs mb-4" id="memberTabs">
                    <li class="nav-item"><button class="nav-link active" onclick="switchMode('commitments')">×”×ª×—×™×™×‘×•×™×•×ª</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="switchMode('payments')">×ª×©×œ×•××™×</button></li>
                </ul>

                <div class="input-bar shadow-sm">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-2">
                            <label class="small">×ª××¨×™×š</label>
                            <input type="date" id="f-date" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label id="f-desc-label" class="small">×ª×™××•×¨</label>
                            <select id="f-desc" class="form-select"></select>
                        </div>
                        <div class="col-md-3">
                            <label id="f-ref-label" class="small">××¡××›×ª×/×”×¢×¨×”</label>
                            <input type="text" id="f-ref" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="small">×¡×›×•×</label>
                            <input type="number" id="f-amount" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success w-100" onclick="addRow()">×”×•×¡×£ (Enter)</button>
                        </div>
                    </div>
                </div>

                <div class="card p-3">
                    <div id="main-table"></div>
                </div>
            </div>

            <div id="page-settings" class="hidden">
                <h2 class="mb-4">×”×’×“×¨×•×ª ××¢×¨×›×ª (×¢××•×“ B)</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>×¨×©×™××ª ××¦×•×•×ª / ×¤×¨×™×˜×™×</h5>
                            <div id="settings-mitzvot-table"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>×××¦×¢×™ ×ª×©×œ×•×</h5>
                            <div id="settings-pay-table"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-summary" class="hidden">
                <h2 class="mb-4">×“×•×— ×™×ª×¨×•×ª ×›×œ×œ×™</h2>
                <div class="card p-3">
                    <div id="summary-table"></div>
                </div>
            </div>

        </main>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
/** ××•×“×œ ×”× ×ª×•× ×™× **/
let data = JSON.parse(localStorage.getItem('shul_app_db')) || {
    members: [],
    mitzvot: ["×¢×œ×™×” ×œ×ª×•×¨×”", "×¤×ª×™×—×ª ×”×™×›×œ", "×§×™×“×•×©", "× ×“×‘×”"],
    payMethods: ["××–×•××Ÿ", "××©×¨××™", "×”×¢×‘×¨×”"],
    logs: [] // {id, memberId, type, date, desc, ref, amount}
};

let currentMemberId = null;
let currentMode = 'commitments'; // ××• payments
let lastSelectedDate = new Date().toISOString().split('T')[0];

function saveData() {
    localStorage.setItem('shul_app_db', JSON.stringify(data));
}

/** × ×™×•×•×˜ ×•×ª×¦×•×’×” **/
function showPage(pageId) {
    $('main > div').addClass('hidden');
    $(`#page-${pageId}`).removeClass('hidden');
    $('.nav-link').removeClass('active');
    
    if(pageId === 'settings') renderSettings();
    if(pageId === 'summary') renderSummary();
}

/** × ×™×”×•×œ ××ª×¤×œ×œ×™× **/
function renderMembers() {
    const term = $('#memberInput').val().toLowerCase();
    const list = $('#membersList').empty();
    
    data.members.filter(m => m.name.toLowerCase().includes(term)).forEach(m => {
        const activeClass = m.id === currentMemberId ? 'active' : '';
        list.append(`
            <div class="d-flex align-items-center mb-1">
                <a class="nav-link ${activeClass} flex-grow-1" onclick="selectMember(${m.id})">${m.name}</a>
                <button class="btn btn-link text-danger p-0 px-2" onclick="deleteMember(${m.id})"><i class="bi bi-trash"></i></button>
            </div>
        `);
    });
}

function handleMemberAction() {
    const name = $('#memberInput').val().trim();
    if (!name) return;
    
    const existing = data.members.find(m => m.name === name);
    if (existing) {
        selectMember(existing.id);
    } else {
        const newMember = { id: Date.now(), name: name };
        data.members.push(newMember);
        saveData();
        renderMembers();
        selectMember(newMember.id);
    }
}

function deleteMember(id) {
    if(confirm("×œ××—×•×§ ××ª ×”××ª×¤×œ×œ ×•×›×œ ×”×™×¡×˜×•×¨×™×™×ª ×”×ª×©×œ×•××™× ×©×œ×•?")) {
        data.members = data.members.filter(m => m.id !== id);
        data.logs = data.logs.filter(l => l.memberId !== id);
        saveData();
        renderMembers();
        showPage('welcome');
    }
}

function selectMember(id) {
    currentMemberId = id;
    const member = data.members.find(m => m.id === id);
    $('#view-member-name').text(member.name);
    $('#f-date').val(lastSelectedDate);
    renderMembers();
    showPage('member');
    switchMode('commitments');
}

/** × ×™×”×•×œ ×˜×‘×œ××•×ª ×•× ×ª×•× ×™× **/
function switchMode(mode) {
    currentMode = mode;
    $('#memberTabs .nav-link').removeClass('active');
    $(`#memberTabs button[onclick="switchMode('${mode}')"]`).addClass('active');
    
    // ×¢×“×›×•×Ÿ ×ª×•×•×™×•×ª ×©×•×¨×ª ×”×–× ×”
    if(mode === 'commitments') {
        $('#f-desc-label').text('×¤×™×¨×•×˜ ××¦×•×•×”');
        $('#f-ref-label').text('×¡×•×’ ×”×›× ×¡×”');
        fillSelect('#f-desc', data.mitzvot);
    } else {
        $('#f-desc-label').text('×××¦×¢×™ ×ª×©×œ×•×');
        $('#f-ref-label').text('××¡××›×ª×');
        fillSelect('#f-desc', data.payMethods);
    }
    
    renderMainTable();
}

function fillSelect(selector, list) {
    const s = $(selector).empty();
    list.forEach(item => s.append(`<option value="${item}">${item}</option>`));
}

function renderMainTable() {
    const tableData = data.logs.filter(l => l.memberId === currentMemberId && l.type === currentMode);
    
    new Tabulator("#main-table", {
        data: tableData,
        layout: "fitColumns",
        columns: [
            {title: "×ª××¨×™×š", field: "date", width: 150},
            {title: "×¤×™×¨×•×˜", field: "desc"},
            {title: "×”×¢×¨×”/××¡××›×ª×", field: "ref"},
            {title: "×¡×›×•×", field: "amount", bottomCalc: "sum", formatter: (cell) => cell.getValue() + " â‚ª"},
            {title: "×¤×¢×•×œ×•×ª", width: 80, hozAlign: "center", formatter: () => "<button class='btn btn-sm btn-outline-danger'><i class='bi bi-x'></i></button>", cellClick: (e, cell) => {
                data.logs = data.logs.filter(l => l.id !== cell.getData().id);
                saveData();
                renderMainTable();
                updateBalance();
            }}
        ]
    });
    updateBalance();
}

function addRow() {
    const amount = parseFloat($('#f-amount').val());
    if(!amount) { alert("× × ×œ×”×–×™×Ÿ ×¡×›×•×"); return; }
    
    lastSelectedDate = $('#f-date').val();
    
    const newLog = {
        id: Date.now(),
        memberId: currentMemberId,
        type: currentMode,
        date: lastSelectedDate,
        desc: $('#f-desc').val(),
        ref: $('#f-ref').val(),
        amount: amount
    };
    
    data.logs.push(newLog);
    saveData();
    
    // ××™×¤×•×¡ ×¡×›×•× ×‘×œ×‘×“
    $('#f-amount').val('');
    renderMainTable();
}

function updateBalance() {
    const logs = data.logs.filter(l => l.memberId === currentMemberId);
    const commits = logs.filter(l => l.type === 'commitments').reduce((a, b) => a + b.amount, 0);
    const pays = logs.filter(l => l.type === 'payments').reduce((a, b) => a + b.amount, 0);
    const bal = commits - pays;
    
    $('#view-balance').text(`â‚ª ${bal.toLocaleString()}`);
    $('#view-balance').css('color', bal > 0 ? '#dc3545' : '#198754');
}

/** ×¢××•×“ B - ×”×’×“×¨×•×ª **/
function renderSettings() {
    const createSettingTable = (selector, key) => {
        new Tabulator(selector, {
            data: data[key].map(val => ({name: val})),
            layout: "fitColumns",
            columns: [
                {title: "×©×", field: "name", editor: "input"},
                {title: "××—×™×§×”", width: 70, formatter: () => "ğŸ—‘ï¸", cellClick: (e, cell) => {
                    data[key].splice(cell.getRow().getIndex(), 1);
                    saveData(); renderSettings();
                }}
            ],
            footerElement: `<button class="btn btn-sm btn-primary m-2" id="add-${key}">+ ×”×•×¡×£ ×©×•×¨×”</button>`
        });
        
        $(`#add-${key}`).off().on('click', () => {
            const n = prompt("×©× ×—×“×©:");
            if(n) { data[key].push(n); saveData(); renderSettings(); }
        });
    };

    createSettingTable("#settings-mitzvot-table", "mitzvot");
    createSettingTable("#settings-pay-table", "payMethods");
}

/** ×“×•×— ×™×ª×¨×•×ª **/
function renderSummary() {
    const summaryData = data.members.map(m => {
        const logs = data.logs.filter(l => l.memberId === m.id);
        const bal = logs.filter(l => l.type === 'commitments').reduce((a, b) => a + b.amount, 0) -
                    logs.filter(l => l.type === 'payments').reduce((a, b) => a + b.amount, 0);
        return { name: m.name, balance: bal };
    });

    new Tabulator("#summary-table", {
        data: summaryData,
        layout: "fitColumns",
        columns: [
            {title: "×©× ×”××ª×¤×œ×œ", field: "name"},
            {title: "×™×ª×¨×” ×œ×ª×©×œ×•×", field: "balance", formatter: cell => {
                const v = cell.getValue();
                return `<span style="color: ${v > 0 ? 'red' : 'green'}">${v.toLocaleString()} â‚ª</span>`;
            }, htmlOutput: true}
        ]
    });
}

// ×××–×™×Ÿ ×œ××§×© Enter ×‘×ª×™×‘×ª ×”×¡×›×•×
$(document).on('keypress', '#f-amount, #f-ref', function(e) {
    if(e.which == 13) addRow();
});

// ×—×™×¤×•×© ×‘×–××Ÿ ×××ª
$('#memberInput').on('input', renderMembers);

$(document).ready(() => {
    renderMembers();
});
</script>

</body>
</html>