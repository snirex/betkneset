<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×‘×™×ª ×›× ×¡×ª - ×’×¨×¡×” ××ª×§×“××ª</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root { --bg-color: #f8f9fa; --text-color: #212529; --card-bg: #ffffff; }
        .dark-mode { --bg-color: #1a1d20; --text-color: #f8f9fa; --card-bg: #2b3035; }
        
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; transition: 0.3s; }
        .card, .sidebar, .modal-content { background-color: var(--card-bg) !important; color: var(--text-color); }
        .sidebar { height: 100vh; border-left: 1px solid #dee2e6; position: sticky; top: 0; }
        .member-list { max-height: 50vh; overflow-y: auto; }
        .input-row-card { background: rgba(0,0,0,0.05); border-radius: 8px; padding: 15px; }
        [x-cloak] { display: none !important; }

        @media (max-width: 768px) {
            .sidebar { height: auto; display: none; }
            .main-content { padding-top: 70px; }
        }
        @media print { .no-print { display: none !important; } .sidebar { display: none; } main { width: 100%; } }
    </style>
</head>
<body x-data="synagogueApp()" :class="darkMode ? 'dark-mode' : ''">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top no-print">
    <div class="container-fluid">
        <button class="navbar-toggler me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
            <span class="navbar-toggler-icon"></span>
        </button>
        <span class="navbar-brand">ğŸ• × ×™×”×•×œ ×‘×™×ª ×›× ×¡×ª</span>
        <div class="d-flex">
            <button @click="darkMode = !darkMode" class="btn btn-sm btn-outline-light me-2" x-text="darkMode ? 'â˜€ï¸ ××¦×‘ ×™×•×' : 'ğŸŒ™ ××¦×‘ ×œ×™×œ×”'"></button>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addMemberModal">+ ×—×“×©</button>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar no-print shadow-sm pt-3 mt-5 mt-md-0">
            <div class="p-2">
                <input type="text" id="memberSearch" x-model="memberSearch" class="form-control mb-3" placeholder="×—×™×¤×•×© ××ª×¤×œ×œ (Esc)">
                <div class="member-list list-group list-group-flush">
                    <template x-for="m in filteredMembers" :key="m.id">
                        <button @click="selectMember(m)" class="list-group-item list-group-item-action d-flex justify-content-between border-0 rounded mb-1" :class="selectedMember?.id === m.id ? 'active' : ''">
                            <span x-text="m.name"></span>
                        </button>
                    </template>
                </div>
                <hr>
                <button @click="view = 'globalSummary'" class="btn btn-link w-100 text-start text-decoration-none">ğŸ“Š ×¡×™×›×•× ×—×•×‘×•×ª (Alt+4)</button>
                <button @click="view = 'management'" class="btn btn-link w-100 text-start text-decoration-none text-secondary">âš™ï¸ × ×™×”×•×œ ××¢×¨×›×ª (Alt+5)</button>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 main-content mt-4 mt-md-0">
            
            <div x-show="view === 'account' && selectedMember" x-cloak>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><span x-text="selectedMember?.name"></span> <small class="text-muted fs-6" x-text="selectedMember?.nickname"></small></h3>
                    <button class="btn btn-outline-dark btn-sm no-print" onclick="window.print()">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                </div>

                <ul class="nav nav-tabs mb-3 no-print">
                    <li class="nav-item"><button class="nav-link" :class="activeTab === 'obligations' ? 'active fw-bold' : ''" @click="setTab('obligations')">×—×™×•×‘×™×</button></li>
                    <li class="nav-item"><button class="nav-link" :class="activeTab === 'payments' ? 'active fw-bold' : ''" @click="setTab('payments')">×ª×©×œ×•××™×</button></li>
                    <li class="nav-item"><button class="nav-link" :class="activeTab === 'summary' ? 'active fw-bold' : ''" @click="setTab('summary')">×¡×™×›×•×</button></li>
                </ul>

                <div class="input-row-card mb-4 no-print" x-show="activeTab !== 'summary'">
                    <div class="row g-2">
                        <div class="col-md-2"><input type="date" x-model="newEntry.date" class="form-control form-control-sm"></div>
                        <div class="col-md-3">
                            <select x-model="newEntry.type" class="form-select form-select-sm">
                                <template x-for="t in (activeTab === 'obligations' ? incomeTypes : paymentMethods)"><option :value="t" x-text="t"></option></template>
                            </select>
                        </div>
                        <div class="col-md-4"><input type="text" x-model="newEntry.description" @keydown.enter="addNewEntry()" class="form-control form-control-sm" placeholder="×¤×™×¨×•×˜ (Enter ×œ×”×•×¡×¤×”)"></div>
                        <div class="col-md-2"><input type="number" x-model="newEntry.amount" @keydown.enter="addNewEntry()" class="form-control form-control-sm" placeholder="×¡×›×•×"></div>
                        <div class="col-md-1"><button @click="addNewEntry()" class="btn btn-primary btn-sm w-100">×”×•×¡×£</button></div>
                    </div>
                </div>
                <div id="mainTable"></div>
            </div>

            <div x-show="view === 'globalSummary'" x-cloak>
                <h3 class="mb-4">ğŸ“Š ×¡×™×›×•× ×—×•×‘×•×ª ×›×œ×œ×™</h3>
                <div id="summaryTable"></div>
            </div>

            <div x-show="view === 'management'" x-cloak>
                <h3 class="mb-4">âš™ï¸ × ×™×”×•×œ ×¨×©×™××•×ª</h3>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card p-3 shadow-sm">
                            <h5>×¡×•×’×™ ×”×›× ×¡×”</h5>
                            <textarea class="form-control mb-2" rows="3" x-model="incomeTypesRaw"></textarea>
                            <button @click="updateLists()" class="btn btn-sm btn-primary">×¢×“×›×Ÿ ×¨×©×™××•×ª</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card p-3 shadow-sm">
                            <h5>×¨×©×™××ª ××ª×¤×œ×œ×™×</h5>
                            <ul class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                                <template x-for="m in members" :key="m.id">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span x-text="m.name"></span>
                                        <button @click="deleteMember(m.id)" class="btn btn-sm text-danger">ğŸ—‘ï¸</button>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">×”×•×¡×¤×ª ××ª×¤×œ×œ ×—×“×©</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label>×©× ××œ×</label><input type="text" x-model="newMember.name" class="form-control"></div>
                <div class="mb-3"><label>×›×™× ×•×™ (×œ××©×œ "××©×” ×”×’×‘××™")</label><input type="text" x-model="newMember.nickname" class="form-control"></div>
                <div class="mb-3"><label>×˜×œ×¤×•×Ÿ</label><input type="text" x-model="newMember.phone" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
                <button @click="addMember()" class="btn btn-success" data-bs-dismiss="modal">×©××•×¨ ××ª×¤×œ×œ</button>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start no-print" tabindex="-1" id="sidebarOffcanvas">
    <div class="offcanvas-header bg-primary text-white"><h5>×ª×¤×¨×™×˜</h5><button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body" x-html="document.getElementById('sidebarMenu').innerHTML"></div>
</div>

<script>
function synagogueApp() {
    return {
        view: 'account',
        activeTab: 'obligations',
        darkMode: localStorage.getItem('darkMode') === 'true',
        memberSearch: '',
        selectedMember: null,
        members: JSON.parse(localStorage.getItem('syn_members')) || [],
        transactions: JSON.parse(localStorage.getItem('syn_tx')) || [],
        incomeTypes: ['×¢×œ×™×™×” ×œ×ª×•×¨×”', '×¤×ª×™×—×ª ×”×”×™×›×œ', '×™×–×›×•×¨', '× ×“×‘×”', '×“××™ ×—×‘×¨'],
        paymentMethods: ['××–×•××Ÿ', '××©×¨××™', '×”×¢×‘×¨×”', '×¦×³×§'],
        incomeTypesRaw: '×¢×œ×™×™×” ×œ×ª×•×¨×”, ×¤×ª×™×—×ª ×”×”×™×›×œ, ×™×–×›×•×¨, × ×“×‘×”, ×“××™ ×—×‘×¨',
        
        newMember: { name: '', nickname: '', phone: '' },
        newEntry: { date: new Date().toISOString().split('T')[0], type: '×¢×œ×™×™×” ×œ×ª×•×¨×”', description: '', amount: '' },
        
        init() {
            this.$watch('darkMode', val => localStorage.setItem('darkMode', val));
            this.$watch('view', () => this.renderTable());
            this.$watch('activeTab', () => this.renderTable());
            
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') document.getElementById('memberSearch').focus();
                if (e.altKey && e.key === '1') { this.view = 'account'; this.activeTab = 'obligations'; }
                if (e.altKey && e.key === '2') { this.view = 'account'; this.activeTab = 'payments'; }
                if (e.altKey && e.key === '3') { this.view = 'account'; this.activeTab = 'summary'; }
                if (e.altKey && e.key === '4') this.view = 'globalSummary';
                if (e.altKey && e.key === '5') this.view = 'management';
            });
        },

        get filteredMembers() {
            return this.members.filter(m => m.name.includes(this.memberSearch));
        },

        selectMember(m) {
            this.selectedMember = m;
            this.view = 'account';
            this.renderTable();
        },

        setTab(t) { this.activeTab = t; this.newEntry.type = (t === 'obligations' ? this.incomeTypes[0] : this.paymentMethods[0]); },

        addMember() {
            if (!this.newMember.name) return;
            const member = { ...this.newMember, id: Date.now() };
            this.members.push(member);
            this.saveData();
            this.newMember = { name: '', nickname: '', phone: '' };
        },

        addNewEntry() {
            if (!this.newEntry.amount || !this.selectedMember) return;
            const entry = { ...this.newEntry, id: Date.now(), memberId: this.selectedMember.id, kind: this.activeTab, amount: parseFloat(this.newEntry.amount) };
            this.transactions.push(entry);
            this.saveData();
            this.newEntry.description = ''; this.newEntry.amount = '';
            this.renderTable();
        },

        renderTable() {
            if (this.view === 'globalSummary') { this.renderGlobalSummary(); return; }
            if (!this.selectedMember) return;

            let data = this.transactions.filter(t => t.memberId === this.selectedMember.id);
            if (this.activeTab !== 'summary') data = data.filter(t => t.kind === this.activeTab);

            new Tabulator("#mainTable", {
                data: data,
                layout: "fitColumns",
                responsiveLayout: "collapse",
                columns: [
                    {title: "×ª××¨×™×š", field: "date", sorter: "date"},
                    {title: "×¡×•×’", field: "type"},
                    {title: "×¤×™×¨×•×˜", field: "description"},
                    {title: "×¡×›×•×", field: "amount", formatter: "money", hozAlign: "left"}
                ]
            });
        },

        renderGlobalSummary() {
            const summary = this.members.map(m => {
                const tx = this.transactions.filter(t => t.memberId === m.id);
                const debt = tx.filter(t => t.kind === 'obligations').reduce((s, t) => s + t.amount, 0);
                const paid = tx.filter(t => t.kind === 'payments').reduce((s, t) => s + t.amount, 0);
                return { name: m.name, debt: debt - paid };
            });

            new Tabulator("#summaryTable", {
                data: summary,
                layout: "fitColumns",
                columns: [
                    {title: "×©× ××ª×¤×œ×œ", field: "name"},
                    {title: "×™×ª×¨×ª ×—×•×‘", field: "debt", formatter: "money", hozAlign: "left", color: (c) => c.getValue() > 0 ? "red" : "green"}
                ]
            });
        },

        deleteMember(id) { if(confirm('×œ××—×•×§?')) { this.members = this.members.filter(m => m.id !== id); this.saveData(); } },
        updateLists() { this.incomeTypes = this.incomeTypesRaw.split(',').map(s => s.trim()); this.saveData(); },
        saveData() {
            localStorage.setItem('syn_members', JSON.stringify(this.members));
            localStorage.setItem('syn_tx', JSON.stringify(this.transactions));
        }
    };
}
</script>
</body>
</html>