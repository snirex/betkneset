
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>× ×™×”×•×œ ×—×©×‘×•× ×•×ª - ××¦×‘ ××§×•××™</title>

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- jQuery + jQueryUI + DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body { display:none; background:#f8f9fa; font-family:"Segoe UI",Tahoma,sans-serif;}
.bg-custom { background: linear-gradient(135deg,#6f86d6 0%,#48c6ef 100%); }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.07); cursor:pointer; }
#firebaseAlert { display:none; }
.edit-actions td { background:#eef; text-align:center; }
tfoot th { background:#f1f1f1; }
body.theme-blue { background: #e6f0ff; color: #003366; }
.stat-card { border-radius:12px; padding:20px; color:#333; text-align:center; }
.stat-red { background:#f8d7da; }
.stat-green { background:#d4edda; }
.stat-yellow { background:#fff3cd; }
</style>
</head>
<body class="theme-blue">

<!-- Alert Firebase -->
<div id="firebaseAlert" class="alert alert-warning alert-dismissible fade show mb-0 text-center" role="alert">
  âš  ××™×Ÿ ×—×™×‘×•×¨ ×œ-Firebase ×›×¨×’×¢. ×”× ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª ×‘×œ×‘×“.
  <button type="button" class="btn-close"></button>
</div>

<!-- Navbar ×¨×¡×¤×•× ×¡×™×‘×™ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">ğŸ  × ×™×”×•×œ ×—×©×‘×•× ×•×ª</a>

    <!-- ×›×¤×ª×•×¨ Hamburger ×œ××¡×›×™× ×§×˜× ×™× -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
      aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="summary.html">ğŸ“‘ ×¡×™×›×•× ×›×•×œ×œ (D)</a></li>
        <li class="nav-item"><a class="nav-link" href="users.html">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™× (E)</a></li>
        <li class="nav-item"><a class="nav-link" href="dashboard.html">ğŸ“Š ×“×•×—×•×ª (F)</a></li>
        <li class="nav-item"><a class="nav-link" href="permissions.html">ğŸ” ×”×¨×©××•×ª (G)</a></li>
        <li class="nav-item">
          <span id="firebaseStatus" class="nav-link text-warning" title="×œ× ××—×•×‘×¨ ×œ-Firebase">
            <i class="bi bi-cloud-slash"></i>
          </span>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- ×›×¨×˜×™×¡×™ ×¡×˜×˜×•×¡ -->
<div class="p-4 rounded bg-white shadow-sm mb-4 text-center">
  <h1>ğŸ“œ × ×™×”×•×œ ×”×›× ×¡×•×ª ×‘×™×ª ×”×›× ×¡×ª</h1>
</div>
<div class="container my-4">
  <div class="row g-3 text-center">
    <div class="col-md-4"><div class="stat-card stat-red"><h4>×¡×”×´×› ×”×ª×—×™×™×‘×•×™×•×ª</h4><div id="statAmount">1,212</div></div></div>
    <div class="col-md-4"><div class="stat-card stat-green"><h4>×¡×”×´×› ×ª×©×œ×•××™×</h4><div id="statActual">1,205</div></div></div>
    <div class="col-md-4"><div class="stat-card stat-yellow"><h4>×××–×Ÿ ×›×œ×œ×™</h4><div id="statBalance">7</div></div></div>
  </div>
</div>

<!-- ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×ª×©×œ×•× + ×—×™×¤×•×© -->
<div class="container py-4">
  <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
    <button id="openAddModal" class="btn btn-primary"><i class="bi bi-plus-circle"></i> ×”×•×¡×£ ×ª×©×œ×•×</button>
    <input type="text" id="globalSearch" class="form-control w-auto" placeholder="ğŸ” ×—×™×¤×•×© ×—×›×...">
  </div>

  <!-- ×˜×‘×œ×ª ×ª×©×œ×•××™× -->
  <div class="table-responsive">
    <table id="paymentsTable" class="display table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th>×ª××¨×™×š</th>
          <th>×©×</th>
          <th>×¡×›×•× ×”×ª×—×™×™×‘×•×ª</th>
          <th>×¤×™×¨×•×˜ ××¦×•×•×”</th>
          <th>×¡×•×’ ×ª×©×œ×•×</th>
          <th>××¡××›×ª×</th>
          <th>×ª×©×œ×•× ×‘×¤×•×¢×œ</th>
          <th>×¤×¢×•×œ×•×ª</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th colspan="2">×¡×”×´×›:</th>
          <th id="sumAmount">0</th>
          <th colspan="3"></th>
          <th id="sumActual">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Modal ×”×•×¡×¤×ª ×ª×©×œ×•× -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addPaymentForm">
        <div class="modal-header">
          <h5 class="modal-title">â• ×”×•×¡×£ ×ª×©×œ×•× ×—×“×©</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <div class="col-6"><label class="form-label">×ª××¨×™×š</label><input type="date" name="date" class="form-control" required></div>
          <div class="col-6"><label class="form-label">×©×</label><input type="text" name="name" class="form-control" required></div>
          <div class="col-6"><label class="form-label">×¡×›×•× ×”×ª×—×™×™×‘×•×ª</label><input type="number" name="amount" class="form-control" required></div>
          <div class="col-6"><label class="form-label">×¤×™×¨×•×˜ ××¦×•×•×”</label><input type="text" name="mitzvah" class="form-control"></div>
          <div class="col-6"><label class="form-label">×¡×•×’ ×ª×©×œ×•×</label><input type="text" name="paymentType" class="form-control"></div>
          <div class="col-6"><label class="form-label">××¡××›×ª×</label><input type="text" name="reference" class="form-control"></div>
          <div class="col-6"><label class="form-label">×ª×©×œ×•× ×‘×¤×•×¢×œ</label><input type="number" name="actualPayment" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> ×©××•×¨</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×˜×œ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function(){
  let localKey = "paymentsLocal";
  let payments = JSON.parse(localStorage.getItem(localKey) || "[]");

  const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));

  // ×”×ª×¨××” Firebase
  $("#firebaseAlert").slideDown();
  $("#firebaseAlert .btn-close").click(()=>$("#firebaseAlert").slideUp());

  const table = $('#paymentsTable').DataTable({
    data: payments,
    columns: [
      { data:'date' },
      { data:'name', render:data=>`<a href="person.html?name=${encodeURIComponent(data)}">${data}</a>` },
      { data:'amount' },
      { data:'mitzvah' },
      { data:'paymentType' },
      { data:'reference' },
      { data:'actualPayment' },
      { data:null, orderable:false,
        render:(data,type,row,meta)=>`
          <button class="btn btn-sm btn-warning edit-row"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-danger delete-row"><i class="bi bi-trash"></i></button>
          <a href="invoice.html?id=${meta.row}" class="btn btn-sm btn-success"><i class="bi bi-receipt"></i></a>
        `
      }
    ],
    searching: false,
    drawCallback: function(){ updateSums(); }
  });

  function saveToStorage(){ localStorage.setItem(localKey,JSON.stringify(payments)); }

  function updateSums(){
    let sumAmount = 0, sumActual = 0;
    payments.forEach(p=>{ sumAmount += Number(p.amount||0); sumActual += Number(p.actualPayment||0); });
    $("#sumAmount").text(sumAmount.toLocaleString());
    $("#sumActual").text(sumActual.toLocaleString());
  }
  updateSums();

  // ×›×¤×ª×•×¨ "×”×•×¡×£ ×ª×©×œ×•×"
  $("#openAddModal").click(()=>modal.show());

  $("#addPaymentForm").submit(function(e){
    e.preventDefault();
    let formData = Object.fromEntries(new FormData(this).entries());
    payments.push(formData);
    saveToStorage();
    table.row.add(formData).draw(false);
    updateSums();
    this.reset();
    modal.hide();
  });

  // ××—×™×§×”
  $('#paymentsTable').on('click','.delete-row',function(){
    let row = table.row($(this).closest('tr'));
    let $tr = $(row.node());
    $tr.fadeOut(400,()=>{ 
      payments.splice(row.index(),1);
      saveToStorage();
      row.remove().draw();
      updateSums();
    });
  });

  // ×—×™×¤×•×© ××•×˜×•××˜×™
  $("#globalSearch").autocomplete({
    source:[...new Set(payments.map(p=>p.name))],
    select:(e,ui)=>{ table.search(ui.item.value).draw(); }
  }).on("input",function(){ table.search(this.value).draw(); });

  $('body').fadeIn(200);
});
</script>
</body>
</html>
