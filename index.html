<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ניהול חשבונות - מצב מקומי</title>

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- jQuery + jQueryUI + DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body { display:none; background:#f8f9fa; font-family:"Segoe UI",Tahoma,sans-serif;}
.bg-custom { background: linear-gradient(135deg,#6f86d6 0%,#48c6ef 100%); }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.07); cursor:pointer; }
#firebaseAlert { display:none; }
tfoot th { background:#f1f1f1; }
body.theme-blue { background: #e6f0ff; color: #003366; }
.stat-card { border-radius:12px; padding:20px; color:#333; text-align:center; }
.stat-red { background:#f8d7da; }
.stat-green { background:#d4edda; }
.stat-yellow { background:#fff3cd; }
tfoot tr.balance-row th { font-weight:bold; font-size:1.1em; }
tfoot tr.balance-row.positive th { background:#d4edda; color:#155724; }
tfoot tr.balance-row.negative th { background:#f8d7da; color:#721c24; }
</style>
</head>
<body class="theme-blue">

<div id="firebaseAlert" class="alert alert-warning alert-dismissible fade show mb-0 text-center" role="alert">
  ⚠ אין חיבור לבסיס הנתונים כרגע. הנתונים נשמרים מקומית בלבד.
  <button type="button" class="btn-close"></button>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">🏠 ניהול חשבונות</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav ms-auto">
	  <li class="nav-item"><a class="nav-link active" href="commitments.html">💼 התחייבויות</a></li>
        <li class="nav-item"><a class="nav-link" href="payments.html">💸 תשלומים</a></li>
		<li class="nav-item"><a class="nav-link" href="manage.html">⚙️ ניהול סוגי הכנסה</a></li>
        <li class="nav-item"><a class="nav-link" href="summary.html">📑 סיכום כולל (D)</a></li>
        <li class="nav-item"><a class="nav-link" href="users.html">👥 ניהול משתמשים (E)</a></li>
        <li class="nav-item"><a class="nav-link" href="dashboard.html">📊 דוחות (F)</a></li>
        <li class="nav-item"><a class="nav-link" href="permissions.html">🔐 הרשאות (G)</a></li>
        <li class="nav-item">
          <span id="firebaseStatus" class="nav-link text-warning" title="לא מחובר ל-Firebase">
            <i class="bi bi-cloud-slash"></i>
          </span>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="p-4 rounded bg-white shadow-sm mb-4 text-center">
  <h1>📜 ניהול הכנסות בית הכנסת</h1>
</div>

<div class="container my-4">
  <div class="row g-3 text-center">
    <div class="col-md-4"><div class="stat-card stat-red"><h4>סה״כ התחייבויות</h4><div id="statAmount">0</div></div></div>
    <div class="col-md-4"><div class="stat-card stat-green"><h4>סה״כ תשלומים</h4><div id="statActual">0</div></div></div>
    <div class="col-md-4"><div class="stat-card stat-yellow"><h4>מאזן כללי</h4><div id="statBalance">0</div></div></div>
  </div>
</div>

<div class="container py-4">
  <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
    <button id="openAddModal" class="btn btn-primary"><i class="bi bi-plus-circle"></i> הוסף תשלום</button>
    <button id="batchInvoiceBtn" class="btn btn-success"><i class="bi bi-receipt"></i> הפקת חשבונית מסומנים</button>
    <input type="text" id="globalSearch" class="form-control w-auto" placeholder="🔍 חיפוש חכם...">
  </div>

  <div class="table-responsive">
    <table id="paymentsTable" class="display table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>תאריך</th>
          <th>שם</th>
          <th>סכום התחייבות</th>
          <th>פירוט מצווה</th>
          <th>סוג תשלום</th>
          <th>אסמכתא</th>
          <th>תשלום בפועל</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th></th>
          <th colspan="2">סה״כ:</th>
          <th id="sumAmount">0</th>
          <th colspan="2"></th>
          <th>סה״כ בפועל:</th>
          <th id="sumActual">0</th>
          <th></th>
        </tr>
        <tr class="balance-row">
          <th colspan="2">מאזן:</th>
          <th id="sumBalance" colspan="6">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Modal הוספת תשלום -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addPaymentForm">
        <div class="modal-header">
          <h5 class="modal-title">➕ הוסף תשלום חדש</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <div class="col-6"><label class="form-label">תאריך</label><input type="date" name="date" class="form-control" required></div>
          <div class="col-6"><label class="form-label">שם</label><input type="text" name="name" class="form-control" required></div>
          <div class="col-6"><label class="form-label">סכום התחייבות</label><input type="number" name="amount" class="form-control" required></div>
          <div class="col-6"><label class="form-label">פירוט מצווה</label><input type="text" name="mitzvah" class="form-control"></div>
          <div class="col-6"><label class="form-label">סוג תשלום</label><input type="text" name="paymentType" class="form-control"></div>
          <div class="col-6"><label class="form-label">אסמכתא</label><input type="text" name="reference" class="form-control"></div>
          <div class="col-6"><label class="form-label">תשלום בפועל</label><input type="number" name="actualPayment" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> שמור</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">בטל</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function(){
  let localKey = "paymentsLocal";
  let payments = JSON.parse(localStorage.getItem(localKey) || "[]");

  function makeToken() { return 't_'+Math.random().toString(36).substr(2,9); }
  payments.forEach(p=>{ if(!p.token) p.token = makeToken(); });
  localStorage.setItem(localKey, JSON.stringify(payments));

  const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
  $("#firebaseAlert").slideDown();
  $("#firebaseAlert .btn-close").click(()=>$("#firebaseAlert").slideUp());

  const table = $('#paymentsTable').DataTable({
    data: payments,
    columns: [
      { data:null, orderable:false, render:()=>'<input type="checkbox" class="row-select">' },
      { data:'date' },
      { data:'name', render:data=>`<a href="person.html?name=${encodeURIComponent(data)}">${data}</a>` },
      { data:'amount' },
      { data:'mitzvah' },
      { data:'paymentType' },
      { data:'reference' },
      { data:'actualPayment' },
      { data:null, orderable:false,
        render:(data,type,row)=>`
          <button class="btn btn-sm btn-warning edit-row"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-danger delete-row"><i class="bi bi-trash"></i></button>
          <button class="btn btn-sm btn-success invoice-row" data-token="${row.token}"><i class="bi bi-receipt"></i></button>
        `
      }
    ],
    searching: false,
    drawCallback: function(){ updateSums(); }
  });

  function saveToStorage(){ localStorage.setItem(localKey,JSON.stringify(payments)); }

  function updateSums(){
    let sumAmount=0,sumActual=0;
    payments.forEach(p=>{ sumAmount+=Number(p.amount||0); sumActual+=Number(p.actualPayment||0); });
    let balance=sumActual-sumAmount;
    $("#sumAmount").text(sumAmount.toLocaleString());
    $("#sumActual").text(sumActual.toLocaleString());
    $("#sumBalance").text(balance.toLocaleString());
  }
  updateSums();

  $("#globalSearch").on("keyup",function(){ table.search(this.value).draw(); });
  $("#openAddModal").click(()=>modal.show());

  $("#addPaymentForm").submit(function(e){
    e.preventDefault();
    const f=$(this).serializeArray();
    let newPay={token:makeToken()};
    f.forEach(x=>newPay[x.name]=x.value);
    payments.push(newPay);
    saveToStorage();
    table.row.add(newPay).draw();
    updateSums();
    modal.hide();
    this.reset();
  });

  // מחיקת שורה
  $('#paymentsTable tbody').on('click','.delete-row',function(){
    let row=table.row($(this).parents('tr'));
    let data=row.data();
    payments=payments.filter(p=>p.token!==data.token);
    saveToStorage();
    row.remove().draw();
    updateSums();
  });

  // הפקת חשבונית ליחיד
  $('#paymentsTable tbody').on('click','.invoice-row',function(){
    let token=$(this).data('token');
    window.open(`invoice.html?token=${encodeURIComponent(token)}`,'_blank');
  });

  // select all checkbox
  $('#selectAll').on('change',function(){
    $('.row-select').prop('checked',this.checked);
  });

  // הפקת חשבונית batch לשורות מסומנות בלבד
  $('#batchInvoiceBtn').click(function(){
    let selected = [];
    $('#paymentsTable tbody tr').each(function(){
      if($(this).find('.row-select').is(':checked')){
        selected.push(table.row(this).data());
      }
    });
    if(selected.length===0){ alert("בחר לפחות שורה אחת להפקת חשבונית"); return; }
    const batchJson = encodeURIComponent(JSON.stringify(selected));
    window.open(`invoice.html?batch=${batchJson}`,'_blank');
  });

  $("body").fadeIn(300);
});
</script>

</body>
</html>
