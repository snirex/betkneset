<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>× ×™×”×•×œ ×—×©×‘×•× ×•×ª ×‘×™×ª ×›× ×¡×ª</title>

  <!-- Bootstrap RTL -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- FileSaver.js -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      padding: 0;
      background: #f1f1f1;
      display: none;
    }

    nav.navbar {
      margin: 0;
      border-radius: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1030;
    }
    .container {
      padding-top: 70px;
    }
    .bg-custom {
      background: linear-gradient(135deg, #72edf2 0%, #5151e5 100%);
      color: white;
    }
    .table-responsive { overflow-x: auto; }
    .form-section { display: none; }
    #toggleForm {
      border: 1px solid gray;
    }
  </style>
</head>
<body class="p-4">

  <nav class="navbar navbar-expand-lg navbar-dark bg-custom mb-4 rounded">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">ğŸ  ×“×£ ×”×‘×™×ª</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="person.html">×›×¨×˜×™×¡ ××“×</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">

    <div class="p-4 rounded bg-white shadow-sm mb-4 text-center">
      <h1>ğŸ“œ × ×™×”×•×œ ×”×›× ×¡×•×ª ×‘×™×ª ×”×›× ×¡×ª</h1>
    </div>

    <button id="toggleForm" class="btn btn-light mb-3">â• ×”×•×¡×£ ×ª×©×œ×•×</button>

    <div class="form-section border p-3 rounded bg-white shadow-sm mb-4">
      <form id="paymentForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">×ª××¨×™×š *</label>
          <input id="dateInput" type="date" class="form-control" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">×©× *</label>
          <input id="nameInput" type="text" class="form-control add-payment" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">×¡×›×•× ×”×ª×—×™×™×‘×•×ª *</label>
          <input id="amountInput" type="number" step="0.01" min="0" class="form-control add-payment" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">×¤×™×¨×•×˜ ××¦×•×•×”</label>
          <input id="mitzvahInput" type="text" class="form-control add-payment" />
        </div>
        <div class="col-md-4">
          <label class="form-label">×¡×•×’ ×ª×©×œ×•×</label>
          <input id="paymentTypeInput" type="text" class="form-control add-payment" />
        </div>
        <div class="col-md-4">
          <label class="form-label">××¡××›×ª×</label>
          <input id="referenceInput" type="text" class="form-control add-payment" />
        </div>
        <div class="col-md-4">
          <label class="form-label">×ª×©×œ×•× ×‘×¤×•×¢×œ</label>
          <input id="actualPaymentInput" type="number" step="0.01" min="0" class="form-control add-payment" />
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">××™×©×•×¨ ×ª×©×œ×•×</button>
        </div>
      </form>
    </div>

    <button id="saveFileBtn" class="btn btn-secondary mb-3">ğŸ’¾ ×©××•×¨ ×§×•×‘×¥ JSON</button>

    <div class="mb-3">
      <label class="form-label">ğŸ” ×—×¤×© ×‘×¨×©×•××•×ª:</label>
      <input type="text" id="searchInput" class="form-control w-50" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×©..." />
    </div>

    <div class="table-responsive">
      <table id="paymentsTable" class="display table table-bordered table-striped w-100">
        <thead class="table-dark text-center">
          <tr>
            <th>×ª××¨×™×š</th>
            <th>×©×</th>
            <th>×¡×›×•× ×”×ª×—×™×™×‘×•×ª</th>
            <th>×¤×™×¨×•×˜ ××¦×•×•×”</th>
            <th>×¡×•×’ ×ª×©×œ×•×</th>
            <th>××¡××›×ª×</th>
            <th>×ª×©×œ×•× ×‘×¤×•×¢×œ</th>
            <th>×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB49uIy5xYqMrdmqea14aBoPVP5Lw24ggI",
      authDomain: "snir-betkneset.firebaseapp.com",
      projectId: "snir-betkneset",
      storageBucket: "snir-betkneset.firebasestorage.app",
      messagingSenderId: "453027350533",
      appId: "1:453027350533:web:db26aa9d4af9fa92d7b46c",
      measurementId: "G-JL634PFGP6"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    $(document).ready(function() {
      let fadeSpeed = 200;
      $('body').fadeIn(fadeSpeed);

      $('a').click(function(e) {
        const link = $(this).attr('href');
        if (link && link !== '#' && !link.startsWith('http')) {
          e.preventDefault();
          $('body').fadeOut(fadeSpeed, function() {
            window.location.href = link;
          });
        }
      });

      const $formSection = $('.form-section');
      const $toggleFormBtn = $('#toggleForm');
      const $paymentsTable = $('#paymentsTable');
      const $searchInput = $('#searchInput');

      let payments = [];

      $('#dateInput').val(new Date().toISOString().substring(0,10));

      $toggleFormBtn.click(() => {
        $formSection.slideToggle(200);
        $('#nameInput').focus();
      });

      let dataTable = $paymentsTable.DataTable({
        data: payments,
        columns: [
          { data: 'date', className: 'text-center' },
          { data: 'name', className: 'text-center', render: data => `<a href="person.html?name=${encodeURIComponent(data)}">${data}</a>` },
          { data: 'amount', className: 'text-center' },
          { data: 'mitzvah', className: 'text-center' },
          { data: 'paymentType', className: 'text-center' },
          { data: 'reference', className: 'text-center' },
          { data: 'actualPayment', className: 'text-center' },
          {
            data: null,
            orderable: false,
            className: 'text-center',
            render: (data, type, row, meta) => `
              <a href="invoice.html?name=${encodeURIComponent(row.name)}&date=${encodeURIComponent(row.date)}&mitzvah=${encodeURIComponent(row.mitzvah)}&paymentType=${encodeURIComponent(row.paymentType)}&amount=${encodeURIComponent(row.amount)}&actualPayment=${encodeURIComponent(row.actualPayment)}"
                target="_blank"
                class="btn btn-success btn-sm">
                ×—×©×‘×•× ×™×ª
              </a>
              <button class="btn btn-danger btn-sm delete" data-id="${row.id}">ğŸ—‘ï¸</button>
            `
          }
        ],
        destroy: true,
        searching: false,
        lengthChange: false,
        paging: true,
        language: {
          emptyTable: "××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”",
          paginate: {
            previous: "×”×§×•×“×",
            next: "×”×‘×"
          }
        }
      });

      function renderTable() {
        dataTable.clear().rows.add(payments).draw();
      }

      // ×”×˜×¢× ×ª ×”× ×ª×•× ×™× ×-Firestore ×‘×–××Ÿ ×××ª
      const paymentsCol = collection(db, "payments");
      const q = query(paymentsCol, orderBy("date", "desc"));

      onSnapshot(q, (querySnapshot) => {
        payments = [];
        querySnapshot.forEach((doc) => {
          payments.push({ id: doc.id, ...doc.data() });
        });
        renderTable();
      }, (error) => {
        console.error("Error loading payments: ", error);
      });

      // ×”×•×¡×¤×ª ×ª×©×œ×•× ×—×“×©
      $('#paymentForm').submit(async function(e) {
        e.preventDefault();

        const newPayment = {
          date: $('#dateInput').val(),
          name: $('#nameInput').val().trim(),
          amount: parseFloat($('#amountInput').val()) || 0,
          mitzvah: $('#mitzvahInput').val().trim(),
          paymentType: $('#paymentTypeInput').val().trim(),
          reference: $('#referenceInput').val().trim(),
          actualPayment: parseFloat($('#actualPaymentInput').val()) || 0
        };

        if (!newPayment.date || !newPayment.name || !newPayment.amount) {
          Swal.fire('×©×’×™××”', '×× × ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×” (×ª××¨×™×š, ×©×, ×¡×›×•× ×”×ª×—×™×™×‘×•×ª)', 'error');
          return;
        }

        try {
          await addDoc(paymentsCol, newPayment);
          Swal.fire('×”×¦×œ×—×”!', '×ª×©×œ×•× × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');
          this.reset();
          $('#dateInput').val(new Date().toISOString().substring(0,10));
          $formSection.slideUp();
        } catch(error) {
          Swal.fire('×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘×”×•×¡×¤×ª ×”×ª×©×œ×•×: ' + error.message, 'error');
        }
      });

      // ××—×™×§×ª ×ª×©×œ×•×
      $paymentsTable.on('click', '.delete', async function() {
        const id = $(this).data('id');

        const result = await Swal.fire({
          title: '××ª×” ×‘×˜×•×—?',
          text: "×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: '×›×Ÿ, ××—×§!',
          cancelButtonText: '×‘×™×˜×•×œ'
        });

        if (result.isConfirmed) {
          try {
            await deleteDoc(doc(db, "payments", id));
            Swal.fire('× ××—×§!', '×”×¨×©×•××” × ××—×§×” ×‘×”×¦×œ×—×”.', 'success');
          } catch(error) {
            Swal.fire('×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘××—×™×§×”: ' + error.message, 'error');
          }
        }
      });

      // ×—×™×¤×•×© ×‘×˜×‘×œ×”
      $searchInput.on('input', function() {
        const val = $(this).val().toLowerCase();
        dataTable.rows().every(function() {
          const data = this.data();
          const combined = `${data.date} ${data.name} ${data.amount} ${data.mitzvah} ${data.paymentType} ${data.reference} ${data.actualPayment}`.toLowerCase();
          if (combined.indexOf(val) !== -1) {
            $(this.node()).show();
          } else {
            $(this.node()).hide();
          }
        });
      });

      // ×©××™×¨×ª JSON ××§×•××™
      $('#saveFileBtn').click(() => {
        if (payments.length === 0) {
          Swal.fire('××™×Ÿ ×¨×©×•××•×ª ×œ×©××™×¨×”', '', 'info');
          return;
        }
        const blob = new Blob([JSON.stringify(payments, null, 2)], {type: "application/json;charset=utf-8"});
        saveAs(blob, "payments.json");
      });

    });
  </script>

</body>
</html>
