
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>כרטיס אדם - ניהול חשבונות</title>

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- jQuery + jQueryUI + DataTables -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body { display:none; background:#f8f9fa; font-family:"Segoe UI",Tahoma,sans-serif;}
.bg-custom { background: linear-gradient(135deg,#6f86d6 0%,#48c6ef 100%); }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.07); cursor:pointer; }
body.theme-blue { background: #e6f0ff; color: #003366; }
.stat-card { border-radius:12px; padding:20px; color:#333; text-align:center; }
.stat-red { background:#f8d7da; }
.stat-green { background:#d4edda; }
.stat-yellow { background:#fff3cd; }
</style>
</head>
<body class="theme-blue">

<!-- Navbar רספונסיבי -->
<nav class="navbar navbar-expand-lg navbar-dark bg-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">🏠 ניהול חשבונות</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
      aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="summary.html">📑 סיכום כולל (D)</a></li>
        <li class="nav-item"><a class="nav-link" href="users.html">👥 ניהול משתמשים (E)</a></li>
        <li class="nav-item"><a class="nav-link" href="dashboard.html">📊 דוחות (F)</a></li>
        <li class="nav-item"><a class="nav-link" href="permissions.html">🔐 הרשאות (G)</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- כותרת ושם האדם -->
<div class="p-4 rounded bg-white shadow-sm mb-4 text-center">
  <h1>📜 פירוט חשבונות של <span id="personName"></span></h1>
</div>

<!-- כרטיסי סטטוס -->
<div class="container my-4">
  <div class="row g-3 text-center">
    <div class="col-md-4"><div class="stat-card stat-red"><h4>סה״כ התחייבויות</h4><div id="statAmount">0</div></div></div>
    <div class="col-md-4"><div class="stat-card stat-green"><h4>סה״כ תשלומים</h4><div id="statActual">0</div></div></div>
    <div class="col-md-4"><div class="stat-card stat-yellow"><h4>מאזן כללי</h4><div id="statBalance">0</div></div></div>
  </div>
</div>

<!-- טווח תאריכים + כפתור הפקת חשבונית -->
<div class="container py-2">
  <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
    <label class="form-label mb-0">מתאריך:</label>
    <input type="date" id="startDate" class="form-control w-auto">
    <label class="form-label mb-0">עד תאריך:</label>
    <input type="date" id="endDate" class="form-control w-auto">
    <button id="filterDates" class="btn btn-primary">🔍 סנן</button>
    <button id="generateInvoice" class="btn btn-success ms-auto"><i class="bi bi-receipt"></i> הפקת חשבונית</button>
  </div>
</div>

<!-- טבלת תשלומים -->
<div class="container py-2">
  <div class="table-responsive">
    <table id="personTable" class="display table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th>תאריך</th>
          <th>סכום התחייבות</th>
          <th>פירוט מצווה</th>
          <th>סוג תשלום</th>
          <th>אסמכתא</th>
          <th>תשלום בפועל</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th>סה״כ:</th>
          <th id="sumAmount">0</th>
          <th colspan="3"></th>
          <th id="sumActual">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function(){
  let localKey = "paymentsLocal";
  let payments = JSON.parse(localStorage.getItem(localKey) || "[]");

  // שם האדם מה-URL
  const urlParams = new URLSearchParams(window.location.search);
  const personName = urlParams.get("name") || "לא ידוע";
  $("#personName").text(personName);

  // סינון לפי שם בלבד
  let personPayments = payments.filter(p => p.name === personName);

  const table = $('#personTable').DataTable({
    data: personPayments,
    columns: [
      { data:'date' },
      { data:'amount' },
      { data:'mitzvah' },
      { data:'paymentType' },
      { data:'reference' },
      { data:'actualPayment' },
      { data:null, orderable:false,
        render:(data,type,row,meta)=>`
          <button class="btn btn-sm btn-success print-invoice" title="חשבונית"><i class="bi bi-receipt"></i></button>
        `
      }
    ],
    searching: false,
    drawCallback: updateSums
  });

  function updateSums(){
    let sumAmount = 0, sumActual = 0;
    personPayments.forEach(p=>{
      sumAmount += Number(p.amount||0);
      sumActual += Number(p.actualPayment||0);
    });
    $("#sumAmount").text(sumAmount.toLocaleString());
    $("#sumActual").text(sumActual.toLocaleString());
    $("#statAmount").text(sumAmount.toLocaleString());
    $("#statActual").text(sumActual.toLocaleString());
    $("#statBalance").text((sumActual - sumAmount).toLocaleString());
  }

  // סינון לפי תאריכים
  $("#filterDates").click(function(){
    const start = $("#startDate").val();
    const end = $("#endDate").val();
    personPayments = payments.filter(p=>{
      if(p.name !== personName) return false;
      if(start && p.date < start) return false;
      if(end && p.date > end) return false;
      return true;
    });
    table.clear().rows.add(personPayments).draw();
  });

  // הפקת חשבונית כוללת
  $("#generateInvoice").click(function(){
    if(personPayments.length === 0){
      alert("אין תשלומים להפיק מהם חשבונית");
      return;
    }
    const batch = encodeURIComponent(JSON.stringify(personPayments));
    window.open(`invoice.html?batch=${batch}`, '_blank');
  });

  // הפקת חשבונית לכל שורה
  $('#personTable').on('click','.print-invoice', function(){
    const rowData = table.row($(this).closest('tr')).data();
    const batch = encodeURIComponent(JSON.stringify([rowData]));
    window.open(`invoice.html?batch=${batch}`, '_blank');
  });

  $('body').fadeIn(200);
});
</script>
</body>
</html>
