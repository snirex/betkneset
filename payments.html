<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>×ª×©×œ×•××™× - × ×™×”×•×œ ×—×©×‘×•× ×•×ª</title>

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- jQuery + jQueryUI + DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body { display:none; background:#f8f9fa; font-family:"Segoe UI",Tahoma,sans-serif;}
.bg-custom { background: linear-gradient(135deg,#6f86d6 0%,#48c6ef 100%); }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.04); cursor:pointer; }
#firebaseAlert { display:none; }
.edit-actions td { background:#eef; text-align:center; }
tfoot th { background:#f1f1f1; }
body.theme-blue { background: #e6f0ff; color: #003366; }
.stat-card { border-radius:12px; padding:20px; color:#333; text-align:center; }
.stat-red { background:#f8d7da; }
.stat-green { background:#d4edda; }
.stat-yellow { background:#fff3cd; }
tfoot tr.balance-row th { font-weight:bold; font-size:1.0em; }
</style>
</head>
<body class="theme-blue">

<nav class="navbar navbar-expand-lg navbar-dark bg-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="payments.html">ğŸ  × ×™×”×•×œ ×—×©×‘×•× ×•×ª</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="commitments.html">ğŸ’¼ ×”×ª×—×™×™×‘×•×™×•×ª</a></li>
        <li class="nav-item"><a class="nav-link active" href="payments.html">ğŸ’¸ ×ª×©×œ×•××™×</a></li>
        <li class="nav-item"><a class="nav-link" href="manage.html">âš™ï¸ × ×™×”×•×œ ×¡×•×’×™ ×”×›× ×¡×”</a></li>
        <li class="nav-item"><a class="nav-link" href="summary.html">ğŸ“‘ ×¡×™×›×•× ×›×•×œ×œ</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="p-4 rounded bg-white shadow-sm mb-4 text-center">
  <h1>ğŸ“¥ ×¨×™×©×•× ×ª×©×œ×•××™×</h1>
</div>

<div class="container py-4">
  <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
    <button id="openAddModal" class="btn btn-primary"><i class="bi bi-plus-circle"></i> ×”×•×¡×£ ×ª×©×œ×•×</button>
    <input type="text" id="globalSearch" class="form-control w-auto" placeholder="ğŸ” ×—×™×¤×•×© ×—×›×...">
  </div>

  <div class="table-responsive">
    <table id="transactionsTable" class="display table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th>×ª××¨×™×š</th>
          <th>×©×</th>
          <th>×¡×›×•× ×ª×©×œ×•×</th>
          <th>×¤×™×¨×•×˜ ××¦×•×•×”</th>
          <th>×¡×•×’ ×”×›× ×¡×”</th>
          <th>××¡××›×ª×</th>
          <th>×ª×©×œ×•× ×‘×¤×•×¢×œ</th>
          <th>×™×ª×¨×” ×¢×“ ×©×•×¨×” ×–×•</th>
          <th>×¤×¢×•×œ×•×ª</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th colspan="2">×¡×”×´×› (×¢××•×“ ×–×”):</th>
          <th id="sumAmount">0</th>
          <th colspan="2"></th>
          <th>×¡×”×´×› ×‘×¤×•×¢×œ:</th>
          <th id="sumActual">0</th>
          <th id="sumBalance" colspan="2">0</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Modal ×”×•×¡×¤×ª/×¢×¨×™×›×ª ×ª× ×•×¢×” -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addForm">
        <div class="modal-header">
          <h5 class="modal-title">â• ×”×•×¡×£ ×ª×©×œ×•×</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <input type="hidden" name="token" id="editToken">
          <input type="hidden" name="txType" value="payment">
          <div class="col-6"><label class="form-label">×ª××¨×™×š</label><input type="date" name="date" id="inputDate" class="form-control" required></div>
          <div class="col-6"><label class="form-label">×©×</label><input type="text" name="name" class="form-control" required></div>
          <!-- <div class="col-6"><label class="form-label">×¡×›×•× ×”×ª×—×™×™×‘×•×ª</label><input type="number" name="amount" class="form-control" required></div> -->
          <div class="col-6"><label class="form-label">×¤×™×¨×•×˜ ××¦×•×•×”</label><input type="text" name="mitzvah" class="form-control"></div>
          <div class="col-6"><label class="form-label">×¡×•×’ ×”×›× ×¡×”</label>
            <select name="paymentType" id="paymentTypeSelect" class="form-select"></select>
          </div>
          <div class="col-6"><label class="form-label">××¡××›×ª×</label><input type="text" name="reference" class="form-control"></div>
          <div class="col-6"><label class="form-label">×ª×©×œ×•× ×‘×¤×•×¢×œ</label><input type="number" name="actualPayment" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> ×©××•×¨</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×˜×œ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function(){
  const TRAN_KEY = "transactionsLocal"; // ×××—×“ ×ª×©×œ×•××™× + ×”×ª×—×™×™×‘×•×™×•×ª
  const LAST_DATE_KEY = "lastDate_payments";
  const modalEl = document.getElementById('addModal');
  const modal = new bootstrap.Modal(modalEl);
  $("#openAddModal").click(()=>openAddModal());

  // ×× ×™×© paymentsLocal ×™×©×Ÿ â€” ××™×’×¨×¦×™×” ××•×˜×•××˜×™×ª (×©×•××¨ ×ª××™××•×ª)
  (function migrateOld(){
    const old = localStorage.getItem("paymentsLocal");
    if(old && !localStorage.getItem(TRAN_KEY)){
      try{
        const arr = JSON.parse(old);
        const migrated = arr.map(p=>{
          return Object.assign({}, p, { txType: 'payment', createdAt: Date.now(), token: p.token || ('t_'+Math.random().toString(36).substr(2,9)) });
        });
        localStorage.setItem(TRAN_KEY, JSON.stringify(migrated));
        console.log("Migrated paymentsLocal -> transactionsLocal");
      }catch(e){ console.warn("migration failed",e); }
    }
  })();

  let transactions = JSON.parse(localStorage.getItem(TRAN_KEY) || "[]");
  // ensure tokens & createdAt
  transactions.forEach(t=>{ if(!t.token) t.token = 't_'+Math.random().toString(36).substr(2,9); if(!t.createdAt) t.createdAt = Date.now(); });

  function saveTransactions(){ localStorage.setItem(TRAN_KEY, JSON.stringify(transactions)); }

  // helper: calculate client's balance up to given date+createdAt
  function calcBalanceUpTo(name, upToDate, upToCreatedAt){
    // balance = sum(actualPayment) - sum(amount)
    let sum = 0;
    transactions.forEach(tx=>{
      if(tx.name !== name) return;
      const txDate = tx.date || "";
      // compare date strings "YYYY-MM-DD" lexicographically OK
      if(txDate < upToDate) {
        sum += (Number(tx.actualPayment || 0) - Number(tx.amount || 0));
      } else if(txDate === upToDate) {
        if((tx.createdAt || 0) <= upToCreatedAt){
          sum += (Number(tx.actualPayment || 0) - Number(tx.amount || 0));
        }
      }
    });
    return sum;
  }

  // build DataTable with filtered txType = 'payment'
  const table = $('#transactionsTable').DataTable({
    data: transactions.filter(t=>t.txType==='payment'),
    columns: [
      { data:'date' },
      { data:'name', render:data=>`<a href="person.html?name=${encodeURIComponent(data)}">${data}</a>` },
      { data:'amount', render:(d)=>Number(d||0).toLocaleString('he-IL') },
      { data:'mitzvah' },
      { data:'paymentType' },
      { data:'reference' },
      { data:'actualPayment', render:(d)=>Number(d||0).toLocaleString('he-IL') },
      { data:null, orderable:false, render:(data,type,row)=>{
          const bal = calcBalanceUpTo(row.name, row.date || "0000-00-00", row.createdAt || 0);
          const cls = bal >= 0 ? 'text-success' : 'text-danger';
          return `<span class="${cls}">${Number(bal||0).toLocaleString('he-IL')}</span>`;
        }
      },
      { data:null, orderable:false, render:(data,type,row)=>{
          return `
            <button class="btn btn-sm btn-warning edit-row"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-danger delete-row"><i class="bi bi-trash"></i></button>
            <button class="btn btn-sm btn-success invoice-row" data-token="${row.token}"><i class="bi bi-receipt"></i></button>
          `;
        }
      }
    ],
    searching: false,
    order: [[0, 'asc'], [8, 'asc']],
    drawCallback: function(){ updateSums(); }
  });

  function reloadTable(){
    const data = transactions.filter(t=>t.txType==='payment').slice().sort((a,b)=>{
      if(a.date!==b.date) return a.date.localeCompare(b.date);
      return (a.createdAt||0) - (b.createdAt||0);
    });
    table.clear();
    table.rows.add(data).draw();
  }

  function updateSums(){
    const pageData = transactions.filter(t=>t.txType==='payment');
    let sumAmount=0,sumActual=0;
    pageData.forEach(p=>{ sumAmount+=Number(p.amount||0); sumActual+=Number(p.actualPayment||0); });
    const balance = sumActual - sumAmount;
    $("#sumAmount").text(sumAmount.toLocaleString('he-IL'));
    $("#sumActual").text(sumActual.toLocaleString('he-IL'));
    $("#sumBalance").text(balance.toLocaleString('he-IL'));
  }
  updateSums();

  // search
  $("#globalSearch").on("keyup",function(){ table.search(this.value).draw(); });

  // load paymentType options from localStorage
  function loadTypesToSelect(){
    const arr = JSON.parse(localStorage.getItem('incomeTypes') || "[]");
    const sel = $("#paymentTypeSelect").empty();
    if(arr.length===0) {
      sel.append(`<option value="">(×œ× ×”×•×’×“×¨×• ×¡×•×’×™ ×”×›× ×¡×”) - ×¢×‘×•×¨ ×œ'× ×™×”×•×œ ×¡×•×’×™ ×”×›× ×¡×”'</option>`);
    } else {
      sel.append(`<option value="">-- ×‘×—×¨ ×¡×•×’ --</option>`);
      arr.forEach(v=> sel.append(`<option value="${v}">${v}</option>`));
    }
  }
  loadTypesToSelect();

  // Synchronize selects when storage changes (other tab)
  window.addEventListener('storage',(e)=>{
    if(e.key==='incomeTypes') loadTypesToSelect();
    if(e.key===TRAN_KEY) {
      transactions = JSON.parse(localStorage.getItem(TRAN_KEY) || "[]");
      reloadTable();
    }
  });

  // Date persistence: on open modal set to last used or today
  function openAddModal(editRowData){
    $("#editToken").val(editRowData ? editRowData.token : "");
    if(editRowData){
      $("#addForm [name=date]").val(editRowData.date||"");
      $("#addForm [name=name]").val(editRowData.name||"");
      $("#addForm [name=amount]").val(editRowData.amount||"");
      $("#addForm [name=mitzvah]").val(editRowData.mitzvah||"");
      $("#addForm [name=paymentType]").val(editRowData.paymentType||"");
      $("#addForm [name=reference]").val(editRowData.reference||"");
      $("#addForm [name=actualPayment]").val(editRowData.actualPayment||"");
      $(".modal-title").text("âœï¸ ×¢×¨×•×š ×ª×©×œ×•×");
    } else {
      $(".modal-title").text("â• ×”×•×¡×£ ×ª×©×œ×•×");
      const last = localStorage.getItem(LAST_DATE_KEY);
      const today = new Date().toISOString().slice(0,10);
      $("#inputDate").val(last || today);
      $("#addForm")[0].reset();
      $("#addForm [name=date]").val(last || today); // reset cleared by reset()
    }
    modal.show();
  }

  // save last date on change
  $("#inputDate").on("change", function(){
    localStorage.setItem(LAST_DATE_KEY, $(this).val());
  });

  $("#addForm").submit(function(e){
    e.preventDefault();
    const f = $(this).serializeArray();
    const obj = {};
    f.forEach(x=> obj[x.name] = x.value);
    if(obj.token){
      // edit existing
      const idx = transactions.findIndex(t=>t.token===obj.token);
      if(idx>=0){
        transactions[idx] = Object.assign({}, transactions[idx], obj, { amount: Number(obj.amount||0), actualPayment: Number(obj.actualPayment||0) });
      }
    } else {
      // new
      const newTx = Object.assign({}, obj, {
        token: 't_'+Math.random().toString(36).substr(2,9),
        txType: 'payment',
        amount: Number(obj.amount||0),
        actualPayment: Number(obj.actualPayment||0),
        createdAt: Date.now()
      });
      transactions.push(newTx);
      // persist last date used for next additions
      localStorage.setItem(LAST_DATE_KEY, obj.date || new Date().toISOString().slice(0,10));
    }
    saveTransactions();
    reloadTable();
    modal.hide();
    this.reset();
  });

  // edit & delete handlers
  $('#transactionsTable tbody').on('click','.delete-row',function(){
    const data = table.row($(this).closest('tr')).data();
    if(!data) return;
    if(!confirm('×”×× ×œ××—×•×§ ×¨×©×•××” ×–×•?')) return;
    transactions = transactions.filter(t=>t.token !== data.token);
    saveTransactions();
    reloadTable();
  });

  $('#transactionsTable tbody').on('click','.edit-row',function(){
    const data = table.row($(this).closest('tr')).data();
    if(!data) return;
    openAddModal(data);
  });

  $('#transactionsTable tbody').on('click','.invoice-row',function(){
    const token = $(this).data('token');
    window.open(`invoice.html?token=${encodeURIComponent(token)}`,'_blank');
  });

  // initial render
  $("body").fadeIn(200);
  reloadTable();
});
</script>

</body>
</html>
