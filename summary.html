<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>סיכום חשבונות - בית הכנסת</title>

<!-- Bootstrap RTL + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- jQuery + DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { display:none; background:#e6f0ff; font-family:"Segoe UI",Tahoma,sans-serif; }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.07); cursor:pointer; }
.number-cell { direction:ltr; text-align:right; }
.status-hayav { color:red; font-weight:bold; }
.status-zakai { color:green; font-weight:bold; }
tfoot tr { font-weight:bold; }
tfoot tr td { direction:ltr; text-align:right; }
.negative { color:red; }
.positive { color:green; }
.btn-actions { text-align:center; margin-bottom:1rem; }
</style>
</head>
<body class="theme-blue">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">🏠 ניהול חשבונות</a>
  </div>
</nav>

<div class="container my-4">

  <!-- כרטיסי סטטיסטיקה -->
  <div class="row text-center mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm border-danger">
        <div class="card-body">
          <h5 class="card-title text-danger">חייבים</h5>
          <p id="statDebtors" class="fs-3 fw-bold">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-success">
        <div class="card-body">
          <h5 class="card-title text-success">זכאים</h5>
          <p id="statCreditors" class="fs-3 fw-bold">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-primary">
        <div class="card-body">
          <h5 class="card-title text-primary">מאזן כולל</h5>
          <p id="statBalance" class="fs-3 fw-bold">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- לחצני פעולה -->
  <div class="btn-actions">
    <button id="printBtn" class="btn btn-primary"><i class="bi bi-printer"></i> הדפס</button>
    <button id="pdfBtn" class="btn btn-success"><i class="bi bi-file-earmark-pdf"></i> ייצא ל-PDF</button>
    <button id="excelBtn" class="btn btn-warning"><i class="bi bi-file-earmark-spreadsheet"></i> ייצא ל-Excel</button>
  </div>

  <!-- טבלת סיכום -->
  <div class="table-responsive">
    <table id="summaryTable" class="display table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th>שם משתמש</th>
          <th>סה״כ התחייבויות</th>
          <th>סה״כ תשלומים</th>
          <th>מאזן</th>
          <th>סטטוס</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th>סה״כ</th>
          <th id="totalAmount" class="number-cell">0</th>
          <th id="totalActual" class="number-cell">0</th>
          <th id="totalBalance" class="number-cell">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>

</div>

<script>
$(function(){
  let payments = JSON.parse(localStorage.getItem("paymentsLocal") || "[]");
  let usersMap = {};

  payments.forEach(p=>{
    let name = p.name || "ללא שם";
    if(!usersMap[name]) usersMap[name] = {amount:0, actual:0};
    usersMap[name].amount += Number(p.amount||0);
    usersMap[name].actual += Number(p.actualPayment||0);
  });

  let usersData = [];
  let totalAmount=0, totalActual=0, debtors=0, creditors=0;
  for(let name in usersMap){
    let a = usersMap[name].amount;
    let act = usersMap[name].actual;
    let bal = act - a;
    let status = bal >= 0 ? "זכאי" : "חייב";
    if(status==="חייב") debtors++; else creditors++;
    usersData.push({name, amount:a, actual:act, balance:bal, status});
    totalAmount += a; totalActual += act;
  }
  let totalBalance = totalActual - totalAmount;

  // סטטיסטיקה
  $("#statDebtors").text(debtors);
  $("#statCreditors").text(creditors);
  $("#statBalance").text(totalBalance.toLocaleString())
                  .css("color", totalBalance<0 ? "red":"green");

  // טבלה
  let table = $('#summaryTable').DataTable({
    data: usersData,
    columns: [
      { data:'name', render:data=>`<a href="person.html?name=${encodeURIComponent(data)}">${data}</a>` },
      { data:'amount', className:"number-cell" },
      { data:'actual', className:"number-cell" },
      { data:'balance', className:"number-cell" },
      { data:'status', render: d => d==="חייב" ? `<span class="status-hayav">${d}</span>` : `<span class="status-zakai">${d}</span>` }
    ],
    searching: false, paging: false, info: false
  });

  // עדכון סיכומים
  $("#totalAmount").text(totalAmount.toLocaleString());
  $("#totalActual").text(totalActual.toLocaleString());
  $("#totalBalance").text(totalBalance.toLocaleString())
    .css("color", totalBalance<0 ? "red":"green")
    .css("font-weight","bold");

  // הדפסה
  $("#printBtn").click(()=>window.print());

  // ייצוא PDF
  $("#pdfBtn").click(()=>{
    let html = `<div class="invoice-container" style="font-family:Rubik, sans-serif; padding:2rem;">
      <header style="display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #5151e5;padding-bottom:1rem;margin-bottom:2rem;">
        <div>
          <h1 style="color:#5151e5;margin:0;font-size:2rem;">סיכום חשבונות</h1>
          <div style="color:#555;font-size:0.9rem;">בית הכנסת המרכזי מושב תלמים<br>טלפון: 08-1234567 | דוא"ל: info@example.org</div>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Temple_Icon.svg/1200px-Temple_Icon.svg.png" style="height:60px;">
      </header>
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr style="background:#5151e5;color:white;">
          <th>שם משתמש</th><th>סה״כ התחייבויות</th><th>סה״כ תשלומים</th><th>מאזן</th><th>סטטוס</th>
        </tr></thead>
        <tbody>${usersData.map(u=>`
          <tr>
            <td>${u.name}</td>
            <td>${u.amount}</td>
            <td>${u.actual}</td>
            <td>${u.balance}</td>
            <td style="color:${u.status==='חייב'?'red':'green'}">${u.status}</td>
          </tr>`).join("")}
        </tbody>
        <tfoot>
          <tr style="background:#f0f0f0;font-weight:bold;">
            <td>סה״כ</td>
            <td>${totalAmount}</td>
            <td>${totalActual}</td>
            <td style="color:${totalBalance<0?'red':'green'}">${totalBalance}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top:2rem;font-size:0.85rem;color:#666;border-top:1px solid #ddd;padding-top:1rem;">
        שים לב: תוקף מסמך זה מותנה בקבלת התשלום במלואו בהתאם לתנאים. אין לראות במסמך זה קבלה.
      </div>
    </div>`;
    html2pdf().from(html).set({margin:0.5, filename:"summary_invoice.pdf", image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}}).save();
  });

  // ייצוא Excel
  $("#excelBtn").click(()=>{
    let wb = XLSX.utils.book_new();
    let ws_data = [["שם משתמש","סה״כ התחייבויות","סה״כ תשלומים","מאזן","סטטוס"]];
    usersData.forEach(u=> ws_data.push([u.name,u.amount,u.actual,u.balance,u.status]));
    ws_data.push(["סה״כ",totalAmount,totalActual,totalBalance,""]);
    let ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Summary");
    XLSX.writeFile(wb, "summary.xlsx");
  });
});
</script>

<!-- XLSX for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
$("body").fadeIn(300);
</script>
</body>
</html>
